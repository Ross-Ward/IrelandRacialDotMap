# IrelandRacialDotMap
Web map of racial distribution in the Republic of Ireland - https://ptjacobsen.com/IrelandRacialDotMap

One of my favorite web maps is The Racial Dot Map generated by the University of Virginia (https://demographics.virginia.edu/DotMap/). Although Ireland does not have the same history of racial segregation, it is becoming increasingly diverse. I thought it would still be interesting to generate a similar map to see where and to what degree racial segregation exists in the Republic of Ireland.

# Data

The only data used in this map come from the Ireland 2016 Census. I use the Small Area Population Statistics table and the ungeneralised Small Area shapefiles. Both can be downloaded from the CSO for free: http://www.cso.ie/en/census/census2016reports/census2016smallareapopulationstatistics/. From the statistics table, I used only the GUID and the columns from Theme 2 Table 2 on ethnic background.

# Process

The first step is to match the small area geographies with the small area census statistics. This could be done with various software, but I used QGIS to import the small area shapefile as a vector layer and the statistics table from csv as an attribute table with no geometry. I then joined the ethnicity data from the statistics table to the shapefile on GUID.

Next step is make the data accessible in Postgres so that I can use the postGIS functions and speed to generate the dots for the final map. I used the DB manager in QGIS to connect to a scratch database and import the shapefiles with census data that I just created. The spatial index is to speed up processing time and converting field names to lowercase to avoid using quotes for columns in Postgres. 

A significant share of the count is listed with ethnicity as Not Stated. With a quick glance at the table, it appears the share of the population of each Small Area varies a lot. In order to preserve population density on the final map, I assumed the distribution of Not Stated responses match the racial distribution of those that did respond with an ethnicity, and separate the Not Stated responses into the other ethnicities. For example, if there are 5 individuals listed as Black and 10 as White Irish and 3 Not Stated, I will recode the responses as 6 for Black and 12 for White Irish. 

PostGIS has a very convenient function called st_generatepoints() which takes a geometry and a number and generates a multipoint object with that number of points randomly placed inside the geometry. This is perfect for creating the dot map given the number of each race in each small area. 

I tried to export each race as a different table, one row for each small area with multipoint geographies for the individuals. But in QGIS layer order with give undue prominence to whichever layer was on top, especially at wider zooms where multiple points would occupy a single pixel. So I instead extract single pixels to their own row matched with a race. This helped a little, but QGIS would render the points in the order they were received from the database, so whichever points I put into the table first would be rendered last. So my solution is to randomly sort the points so that no race has any render bias. Despite some fear, this did not add meaningful time to the Postgres processing time.

At wider zooms the points become very crowded and it becomes impossible to distinguish between different levels of density. For clarity I also generated layers with 1/3 of the true population and 1/10 of the true population for use at wider zooms.

The final data processing step is to generate the tiles for the web map. I add the newly generated tables as layers in QGIS and color the points by ethnicity. I used a QGIS style file to ensure a consistent colors and labels between labels. To my surprise, QGIS has very little trouble plotting over four million points. I can then use the Qtiles plugin to generate the png map tiles. I have to do it three times; once with the layer with one tenth of the population for zoom levels 7-9, once with the layer with one third of the population for zoom levels 10-11 and once for the full population layer for zoom levels 12-14. The background transparency need to be set to 0 so that the basemap can be seen behind the dots for context. This process tool about 12 hours into total, creating over 80,000 files, but a reasonable 237mb.

Qtiles includes a feature to generate a leaflet based viewer. This served as a starting point for the final map. I removed the layer selectors, made the map full screen, set zoom constraints, and created a legend. The legend automatically updates with the correct number of people per dot. I chose Stamen Toner Lite as the basemap because its white background allows the colors to be seen and minimal other markings provides context without getting in the way.

